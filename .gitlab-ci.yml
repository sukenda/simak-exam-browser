stages:
  - build
  - release
  - deploy

variables:
  # NODE_ENV harus development saat build agar devDependencies (esbuild, electron-builder) terinstall
  NODE_ENV: development
  # Jangan skip devDependencies
  NPM_CONFIG_OMIT: ""
  ELECTRON_CACHE: "$CI_PROJECT_DIR/.cache/electron"
  ELECTRON_BUILDER_CACHE: "$CI_PROJECT_DIR/.cache/electron-builder"
  EXAM_APP_URL: "https://simakkhaskempek.com/"
  ATTENTION_WEBHOOK_URL: "https://api.simakkhaskempek.com/"
  ADMIN_PIN: "khashebat"
  ADMIN_SHORTCUT: "Ctrl+Alt+Shift+A"
  PAGES_URL: "https://simak-khas-kempek.gitlab.io/simak-exam-browser"
  SENTRY_DSN: "https://db5e61cf96519bd2b7e46afbff6e26cc@o271614.ingest.us.sentry.io/4510430173986816"

.cache:
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/
      - node_modules/

# ============================================================
# Build Windows (.exe)
# ============================================================
build_windows:
  stage: build
  image: electronuserland/builder:wine
  extends: .cache
  script:
    # Install ALL dependencies (termasuk devDependencies seperti esbuild, electron-builder)
    - npm ci --include=dev
    - |
      # Extract versi dari tag (misalnya v0.2.0 -> 0.2.0)
      VERSION=${CI_COMMIT_TAG#v}
      echo "Building Windows version: $VERSION"
      
      # Update versi di package.json
      npm version $VERSION --no-git-tag-version
      
      # Install dependencies untuk native module (optional, akan skip jika gagal)
      if [ -d "native/keyboard-hook" ]; then
        cd native/keyboard-hook
        npm install || echo "Native module dependencies install skipped"
        cd ../..
      fi
      
      # ============================================================
      # AUTO_UPDATE_URL - GitLab Pages
      # ============================================================
      # URL untuk auto-update (GitLab Pages - URL selalu sama untuk semua versi)
      UPDATE_URL="${PAGES_URL}/"
      
      # Buat file .env
      echo "EXAM_APP_URL=${EXAM_APP_URL}" > .env
      echo "ATTENTION_WEBHOOK_URL=${ATTENTION_WEBHOOK_URL}" >> .env
      echo "ADMIN_PIN=${ADMIN_PIN}" >> .env
      echo "ADMIN_SHORTCUT=${ADMIN_SHORTCUT}" >> .env
      echo "AUTO_UPDATE_URL=${UPDATE_URL}" >> .env
      if [ -n "${SENTRY_DSN}" ]; then
        echo "SENTRY_DSN=${SENTRY_DSN}" >> .env
        echo "SENTRY_DSN configured"
      else
        echo "SENTRY_DSN not set (crash reporting will use Electron crashReporter)"
      fi
      
      echo "============================================================"
      echo "AUTO_UPDATE_URL: ${UPDATE_URL}"
      echo "GitLab Pages akan hosting file update"
      echo "============================================================"
    # Clean dist folder
    - rm -rf dist
    # Build TypeScript - pastikan esbuild sudah terinstall
    - npm run build:ts
    # Native module skip di CI (hanya untuk Windows runtime)
    - echo "Skipping native module build in CI (Windows only)"
    # Build dengan --publish never untuk generate latest.yml tanpa upload
    - npx electron-builder --win --publish never
    - echo "$CI_JOB_ID" > build_job_id_windows.txt
    # Tampilkan isi folder output untuk debug
    - echo "=== Isi folder out ===" && ls -la out/ || echo "folder out tidak ditemukan"
    - echo "=== Isi folder dist ===" && ls -la dist/ || echo "folder dist tidak ditemukan"
    # Tampilkan isi latest.yml untuk verifikasi
    - echo "=== Isi latest.yml ===" && (cat out/latest.yml || cat dist/latest.yml || echo "latest.yml tidak ditemukan")
  artifacts:
    when: always
    paths:
      - out/*
      - dist/*
      - build_job_id_windows.txt
    expire_in: never
  rules:
    - if: '$CI_COMMIT_TAG'

# ============================================================
# Build Linux Ubuntu (.deb)
# ============================================================
build_linux:
  stage: build
  image: electronuserland/builder:latest
  extends: .cache
  script:
    # Install ALL dependencies (termasuk devDependencies seperti esbuild, electron-builder)
    - npm ci --include=dev
    - |
      # Extract versi dari tag (misalnya v0.2.0 -> 0.2.0)
      VERSION=${CI_COMMIT_TAG#v}
      echo "Building Linux version: $VERSION"
      
      # Update versi di package.json
      npm version $VERSION --no-git-tag-version
      
      # URL untuk auto-update (GitLab Pages)
      UPDATE_URL="${PAGES_URL}/"
      
      # Buat file .env
      echo "EXAM_APP_URL=${EXAM_APP_URL}" > .env
      echo "ATTENTION_WEBHOOK_URL=${ATTENTION_WEBHOOK_URL}" >> .env
      echo "ADMIN_PIN=${ADMIN_PIN}" >> .env
      echo "ADMIN_SHORTCUT=${ADMIN_SHORTCUT}" >> .env
      echo "AUTO_UPDATE_URL=${UPDATE_URL}" >> .env
      if [ -n "${SENTRY_DSN}" ]; then
        echo "SENTRY_DSN=${SENTRY_DSN}" >> .env
        echo "SENTRY_DSN configured"
      else
        echo "SENTRY_DSN not set (crash reporting will use Electron crashReporter)"
      fi
      
      echo "============================================================"
      echo "Building for Linux Ubuntu (.deb)"
      echo "AUTO_UPDATE_URL: ${UPDATE_URL}"
      echo "============================================================"
    # Clean dist folder
    - rm -rf dist
    # Build TypeScript
    - npm run build:ts
    # Native keyboard hook hanya untuk Windows, skip di Linux
    - echo "Skipping native module (Windows only, Linux uses Electron API fallback)"
    # Build Linux .deb package (icon akan dikonversi otomatis dari .ico)
    - npx electron-builder --linux --publish never
    - echo "$CI_JOB_ID" > build_job_id_linux.txt
    # Tampilkan isi folder output untuk debug
    - echo "=== Isi folder out ===" && ls -la out/ || echo "folder out tidak ditemukan"
    - echo "=== Isi latest-linux.yml ===" && (cat out/latest-linux.yml || echo "latest-linux.yml tidak ditemukan")
  artifacts:
    when: always
    paths:
      - out/*
      - dist/*
      - build_job_id_linux.txt
    expire_in: never
  rules:
    - if: '$CI_COMMIT_TAG'

# ============================================================
# Release - Create GitLab Release with all assets
# ============================================================
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build_windows
      artifacts: true
    - job: build_linux
      artifacts: true
  script:
    - BUILD_JOB_ID_WIN=$(cat build_job_id_windows.txt)
    - BUILD_JOB_ID_LINUX=$(cat build_job_id_linux.txt)
    - VERSION=${CI_COMMIT_TAG#v}
    # URL untuk download dari GitLab Pages
    - PAGES_DOWNLOAD="${PAGES_URL}"
    - |
      echo "Creating release for version ${VERSION}"
      echo "Build Job ID (Windows): ${BUILD_JOB_ID_WIN}"
      echo "Build Job ID (Linux): ${BUILD_JOB_ID_LINUX}"
      echo "Pages URL: ${PAGES_DOWNLOAD}"
    - >
      release-cli create
      --name "simak-exam-browser ${VERSION}"
      --tag-name "${CI_COMMIT_TAG}"
      --description "Release version ${VERSION}

      ## Download

      ### Windows
      - [Setup Installer (.exe)](${PAGES_DOWNLOAD}/simak-exam-browser-Setup-${VERSION}.exe)

      ### Linux Ubuntu
      - [Debian Package (.deb)](${PAGES_DOWNLOAD}/simak-exam-browser-${VERSION}-linux-amd64.deb)
      - Install: \`sudo dpkg -i simak-exam-browser-${VERSION}-linux-amd64.deb\`
      - Fix dependencies: \`sudo apt-get install -f\`

      ## Auto Update
      Aplikasi akan otomatis mengecek update dari GitLab Pages.
      - Windows: ${PAGES_DOWNLOAD}/latest.yml
      - Linux: ${PAGES_DOWNLOAD}/latest-linux.yml"
      --assets-link "{\"name\":\"Windows Installer (.exe)\",\"url\":\"${PAGES_DOWNLOAD}/simak-exam-browser-Setup-${VERSION}.exe\",\"link_type\":\"package\"}"
      --assets-link "{\"name\":\"Linux Package (.deb)\",\"url\":\"${PAGES_DOWNLOAD}/simak-exam-browser-${VERSION}-linux-amd64.deb\",\"link_type\":\"package\"}"
      --assets-link "{\"name\":\"latest.yml (Windows)\",\"url\":\"${PAGES_DOWNLOAD}/latest.yml\",\"link_type\":\"other\"}"
      --assets-link "{\"name\":\"latest-linux.yml (Linux)\",\"url\":\"${PAGES_DOWNLOAD}/latest-linux.yml\",\"link_type\":\"other\"}"
  rules:
    - if: '$CI_COMMIT_TAG'

# ============================================================
# GitLab Pages - Hosting file update untuk Windows & Linux
# ============================================================
pages:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build_windows
      artifacts: true
    - job: build_linux
      artifacts: true
  script:
    - VERSION=${CI_COMMIT_TAG#v}
    - echo "Deploying version ${VERSION} to GitLab Pages"
    
    # Debug: tampilkan isi folder artifacts
    - echo "=== Isi folder out ===" && ls -la out/ || echo "folder out tidak ditemukan"
    - echo "=== Isi folder dist ===" && ls -la dist/ || echo "folder dist tidak ditemukan"
    
    # Buat folder public untuk GitLab Pages
    - mkdir -p public
    
    # ============================================================
    # Copy Windows files
    # ============================================================
    - echo "=== Copying Windows files ==="
    # Copy latest.yml untuk Windows
    - cp out/latest.yml public/latest.yml || cp dist/latest.yml public/latest.yml
    # Copy installer Windows
    - cp out/simak-exam-browser-Setup-${VERSION}.exe public/simak-exam-browser-Setup-${VERSION}.exe
    
    # ============================================================
    # Copy Linux files
    # ============================================================
    - echo "=== Copying Linux files ==="
    # Copy latest-linux.yml
    - cp out/latest-linux.yml public/latest-linux.yml || echo "latest-linux.yml not found (skipping)"
    # Copy .deb package
    - cp out/simak-exam-browser-${VERSION}-linux-amd64.deb public/simak-exam-browser-${VERSION}-linux-amd64.deb || echo "Linux .deb not found (skipping)"
    
    # ============================================================
    # Buat file index.html dengan download links untuk Windows & Linux
    # ============================================================
    - |
      cat > public/index.html << 'HTMLEOF'
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SIMAK Exam Browser - Downloads</title>
        <style>
          * { box-sizing: border-box; }
          body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 40px 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
          }
          .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
          }
          h1 { 
            color: #1b5e20; 
            margin-bottom: 8px;
            font-size: 2.5em;
          }
          .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
          }
          .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            margin-bottom: 30px;
          }
          .platforms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 30px 0;
          }
          .platform-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
          }
          .platform-card:hover {
            border-color: #2e7d32;
            box-shadow: 0 5px 20px rgba(46,125,50,0.15);
          }
          .platform-icon {
            font-size: 48px;
            margin-bottom: 16px;
          }
          .platform-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
          }
          .download-btn { 
            display: inline-block; 
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
            color: white; 
            padding: 14px 28px; 
            text-decoration: none; 
            border-radius: 8px; 
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
          }
          .download-btn:hover { 
            background: linear-gradient(135deg, #1b5e20, #0d4a12);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(27,94,32,0.3);
          }
          .install-cmd {
            background: #263238;
            color: #80cbc4;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
            margin-top: 12px;
            overflow-x: auto;
          }
          .section-title {
            font-size: 1.4em;
            color: #333;
            margin-top: 40px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
          }
          .file-list {
            list-style: none;
            padding: 0;
          }
          .file-list li {
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
          }
          .file-list a {
            color: #2e7d32;
            text-decoration: none;
            font-weight: 500;
          }
          .file-list a:hover {
            text-decoration: underline;
          }
          .file-desc {
            color: #666;
            font-size: 0.9em;
          }
          footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            color: #666;
            text-align: center;
          }
          .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
          }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>üéì SIMAK Exam Browser</h1>
          <p class="subtitle">Aplikasi browser khusus untuk ujian dengan fitur keamanan</p>
          <div class="version-badge">üì¶ Versi VERSION_PLACEHOLDER</div>
          
          <div class="platforms">
            <div class="platform-card">
              <div class="platform-icon">ü™ü</div>
              <div class="platform-title">Windows</div>
              <p style="color: #666; margin-bottom: 16px;">Windows 10/11 (64-bit)</p>
              <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER.exe" class="download-btn">
                ‚¨áÔ∏è Download Installer
              </a>
            </div>
            
            <div class="platform-card">
              <div class="platform-icon">üêß</div>
              <div class="platform-title">Linux Ubuntu</div>
              <p style="color: #666; margin-bottom: 16px;">Ubuntu/Debian (64-bit)</p>
              <a href="simak-exam-browser-VERSION_PLACEHOLDER-linux-amd64.deb" class="download-btn">
                ‚¨áÔ∏è Download .deb Package
              </a>
              <div class="install-cmd">
                sudo dpkg -i simak-exam-browser-VERSION_PLACEHOLDER-linux-amd64.deb
              </div>
            </div>
          </div>
          
          <div class="note">
            <strong>üí° Catatan untuk Linux:</strong> Jika ada error dependency, jalankan: <code>sudo apt-get install -f</code>
          </div>
          
          <h3 class="section-title">üîÑ Auto Update</h3>
          <p>Aplikasi akan otomatis mengecek dan mengunduh update saat dibuka.</p>
          
          <h3 class="section-title">üìÅ Semua File</h3>
          <ul class="file-list">
            <li>
              <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER.exe">simak-exam-browser-Setup-VERSION_PLACEHOLDER.exe</a>
              <span class="file-desc"> - Installer Windows</span>
            </li>
            <li>
              <a href="simak-exam-browser-VERSION_PLACEHOLDER-linux-amd64.deb">simak-exam-browser-VERSION_PLACEHOLDER-linux-amd64.deb</a>
              <span class="file-desc"> - Package Linux (.deb)</span>
            </li>
            <li>
              <a href="latest.yml">latest.yml</a>
              <span class="file-desc"> - Info versi untuk auto-updater (Windows)</span>
            </li>
            <li>
              <a href="latest-linux.yml">latest-linux.yml</a>
              <span class="file-desc"> - Info versi untuk auto-updater (Linux)</span>
            </li>
          </ul>
          
          <footer>
            <p>üè´ SIMAK KHAS Kempek Cirebon</p>
          </footer>
        </div>
      </body>
      </html>
      HTMLEOF
      sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" public/index.html
    
    # Tampilkan isi folder public
    - echo "=== Isi folder public ===" && ls -la public/
    - echo "=== Isi latest.yml (Windows) ===" && cat public/latest.yml || echo "latest.yml not found"
    - echo "=== Isi latest-linux.yml (Linux) ===" && cat public/latest-linux.yml || echo "latest-linux.yml not found"
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_TAG'