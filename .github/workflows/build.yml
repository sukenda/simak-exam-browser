name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.2.0)'
        required: true
        default: '0.1.0'

env:
  NODE_ENV: development
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  # ============================================================
  # Build Windows (.exe) with Native Keyboard Hook Module
  # ============================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Update version in package.json
        shell: bash
        run: npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      # ============================================================
      # Build Native Keyboard Hook Module (Windows Only)
      # ============================================================
      - name: Setup Python for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install native module dependencies
        working-directory: native/keyboard-hook
        run: npm install

      - name: Get Electron version
        id: electron-version
        run: |
          $version = node get-electron-version.js
          $version = $version.Trim()
          echo "ELECTRON_VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Electron version: $version"
        shell: pwsh

      - name: Build native keyboard hook module
        working-directory: native/keyboard-hook
        run: npm run rebuild
        env:
          ELECTRON_VERSION: ${{ steps.electron-version.outputs.ELECTRON_VERSION }}
          npm_config_target: ${{ steps.electron-version.outputs.ELECTRON_VERSION }}
          npm_config_arch: x64
          npm_config_disturl: https://electronjs.org/headers
          npm_config_runtime: electron

      - name: Verify native module build
        shell: bash
        run: |
          echo "=== Checking native module ==="
          if [ -f "native/keyboard-hook/build/Release/keyboard-hook.node" ]; then
            echo "‚úÖ Native keyboard hook module built successfully"
            ls -la native/keyboard-hook/build/Release/
          else
            echo "‚ùå Native module not found!"
            exit 1
          fi

      # ============================================================
      # Create .env file
      # ============================================================
      - name: Create .env file
        shell: bash
        run: |
          PAGES_URL="https://${{ github.repository_owner }}.github.io/simak-exam-browser"
          cat > .env << EOF
          EXAM_APP_URL=${{ secrets.EXAM_APP_URL || 'https://simakkhaskempek.com/' }}
          ATTENTION_WEBHOOK_URL=${{ secrets.ATTENTION_WEBHOOK_URL || 'https://api.simakkhaskempek.com/' }}
          ADMIN_PIN=${{ secrets.ADMIN_PIN || 'simakkhaskempek' }}
          ADMIN_SHORTCUT=${{ secrets.ADMIN_SHORTCUT || 'Ctrl+Alt+Shift+A+H' }}
          AUTO_UPDATE_URL=${PAGES_URL}/
          SENTRY_DSN=${{ secrets.SENTRY_DSN || '' }}
          EOF
          echo "============================================================"
          echo "AUTO_UPDATE_URL: ${PAGES_URL}/"
          echo "============================================================"

      # ============================================================
      # Build TypeScript and Electron App
      # ============================================================
      - name: Clean dist folder
        shell: bash
        run: rm -rf dist

      - name: Build TypeScript
        run: npm run build:ts

      - name: Build Windows 64-bit Installer
        run: npx electron-builder --win --x64 --publish never

      - name: Clean latest.yml (keep only x64 files)
        run: node scripts/clean-latest-yml.js out/latest.yml out/latest.yml x64

      - name: List output files
        shell: bash
        run: |
          echo "=== Output files ==="
          ls -la out/ || echo "out folder not found"
          echo "=== latest.yml (x64) ==="
          cat out/latest.yml || echo "latest.yml not found"

      - name: Upload Windows 64-bit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            out/*x64*.exe
            out/latest.yml
          retention-days: 30

  # ============================================================
  # Build Windows 32-bit (.exe) with Native Keyboard Hook Module
  # ============================================================
  build-windows-ia32:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Update version in package.json
        shell: bash
        run: npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      # ============================================================
      # Build Native Keyboard Hook Module (Windows 32-bit)
      # ============================================================
      - name: Setup Python for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install native module dependencies
        working-directory: native/keyboard-hook
        run: npm install

      - name: Get Electron version
        id: electron-version
        run: |
          $version = node get-electron-version.js
          $version = $version.Trim()
          echo "ELECTRON_VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Electron version: $version"
        shell: pwsh

      - name: Build native keyboard hook module (32-bit)
        working-directory: native/keyboard-hook
        run: npm run rebuild
        env:
          ELECTRON_VERSION: ${{ steps.electron-version.outputs.ELECTRON_VERSION }}
          npm_config_target: ${{ steps.electron-version.outputs.ELECTRON_VERSION }}
          npm_config_arch: ia32
          npm_config_disturl: https://electronjs.org/headers
          npm_config_runtime: electron

      - name: Verify native module build
        shell: bash
        run: |
          echo "=== Checking native module (32-bit) ==="
          if [ -f "native/keyboard-hook/build/Release/keyboard-hook.node" ]; then
            echo "‚úÖ Native keyboard hook module built successfully (32-bit)"
            ls -la native/keyboard-hook/build/Release/
          else
            echo "‚ùå Native module not found!"
            exit 1
          fi

      # ============================================================
      # Create .env file
      # ============================================================
      - name: Create .env file
        shell: bash
        run: |
          PAGES_URL="https://${{ github.repository_owner }}.github.io/simak-exam-browser"
          cat > .env << EOF
          EXAM_APP_URL=${{ secrets.EXAM_APP_URL || 'https://simakkhaskempek.com/' }}
          ATTENTION_WEBHOOK_URL=${{ secrets.ATTENTION_WEBHOOK_URL || 'https://api.simakkhaskempek.com/' }}
          ADMIN_PIN=${{ secrets.ADMIN_PIN || 'khashebat' }}
          ADMIN_SHORTCUT=${{ secrets.ADMIN_SHORTCUT || 'Ctrl+Alt+Shift+A' }}
          AUTO_UPDATE_URL=${PAGES_URL}/
          SENTRY_DSN=${{ secrets.SENTRY_DSN || '' }}
          EOF
          echo "============================================================"
          echo "Building for Windows 32-bit (ia32)"
          echo "AUTO_UPDATE_URL: ${PAGES_URL}/"
          echo "============================================================"

      # ============================================================
      # Build TypeScript and Electron App
      # ============================================================
      - name: Clean dist folder
        shell: bash
        run: rm -rf dist

      - name: Build TypeScript
        run: npm run build:ts

      - name: Build Windows 32-bit Installer
        run: npx electron-builder --win --ia32 --publish never

      - name: Rename latest.yml to latest-ia32.yml
        shell: bash
        run: |
          if [ -f "out/latest.yml" ]; then
            mv out/latest.yml out/latest-ia32.yml
            echo "‚úÖ Renamed latest.yml to latest-ia32.yml"
          else
            echo "‚ö†Ô∏è latest.yml not found"
          fi

      - name: Clean latest-ia32.yml (keep only ia32 files)
        run: node scripts/clean-latest-yml.js out/latest-ia32.yml out/latest-ia32.yml ia32

      - name: List output files
        shell: bash
        run: |
          echo "=== Output files ==="
          ls -la out/ || echo "out folder not found"
          echo "=== latest-ia32.yml ==="
          cat out/latest-ia32.yml || echo "latest-ia32.yml not found"

      - name: Upload Windows 32-bit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-ia32-build
          path: |
            out/*ia32*.exe
            out/latest-ia32.yml
          retention-days: 30

  # ============================================================
  # Create GitHub Release
  # ============================================================
  release:
    needs: [build-windows, build-windows-ia32]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Windows 64-bit artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: artifacts/windows-x64

      - name: Download Windows 32-bit artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-ia32-build
          path: artifacts/windows-ia32

      - name: List all artifacts
        run: |
          echo "=== Windows 64-bit artifacts ==="
          ls -la artifacts/windows-x64/
          echo "=== Windows 32-bit artifacts ==="
          ls -la artifacts/windows-ia32/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: simak-exam-browser v${{ steps.version.outputs.VERSION }}
          body: |
            ## Download

            ### Windows 64-bit (Recommended)
            - **Installer (.exe)**: simak-exam-browser-Setup-${{ steps.version.outputs.VERSION }}-x64.exe
            - Untuk Windows 10/11 64-bit (komputer modern)
            - Native keyboard hook: ‚úÖ Built-in

            ### Windows 32-bit
            - **Installer (.exe)**: simak-exam-browser-Setup-${{ steps.version.outputs.VERSION }}-ia32.exe
            - Untuk Windows 10/11 32-bit atau komputer lama
            - Native keyboard hook: ‚úÖ Built-in

            ## Fitur Keamanan
            - ‚úÖ Blokir Windows key, Alt+Tab, Ctrl+Shift+Esc
            - ‚úÖ Mode kiosk fullscreen
            - ‚úÖ Monitoring fokus window
            - ‚úÖ Auto-update otomatis

            ## Auto Update
            Aplikasi akan otomatis mengecek update saat dibuka.
          files: |
            artifacts/windows-x64/*.exe
            artifacts/windows-x64/latest.yml
            artifacts/windows-ia32/*.exe
            artifacts/windows-ia32/latest-ia32.yml
          draft: false
          prerelease: false

  # ============================================================
  # Deploy to GitHub Pages for Auto-Update
  # ============================================================
  deploy-pages:
    needs: [build-windows, build-windows-ia32]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Windows 64-bit artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: artifacts/windows-x64

      - name: Download Windows 32-bit artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-ia32-build
          path: artifacts/windows-ia32

      - name: Prepare GitHub Pages content
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p public
          
          # Copy Windows 64-bit files
          cp artifacts/windows-x64/*.exe public/ || echo "No Windows 64-bit exe found"
          cp artifacts/windows-x64/latest.yml public/latest.yml || echo "No latest.yml found"
          
          # Copy Windows 32-bit files
          cp artifacts/windows-ia32/*.exe public/ || echo "No Windows 32-bit exe found"
          cp artifacts/windows-ia32/latest-ia32.yml public/latest-ia32.yml || echo "No latest-ia32.yml found"
          
          # Create index.html
          cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SIMAK Exam Browser - Downloads</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
                min-height: 100vh;
                color: #e2e8f0;
              }
              .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 60px 20px;
              }
              .header {
                text-align: center;
                margin-bottom: 50px;
              }
              h1 { 
                font-size: 3em;
                font-weight: 700;
                background: linear-gradient(135deg, #10b981, #3b82f6);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 12px;
              }
              .subtitle {
                color: #94a3b8;
                font-size: 1.1em;
              }
              .version-badge {
                display: inline-block;
                background: rgba(16, 185, 129, 0.2);
                color: #10b981;
                padding: 10px 24px;
                border-radius: 30px;
                font-weight: 600;
                margin-top: 20px;
                border: 1px solid rgba(16, 185, 129, 0.3);
              }
              .platforms {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 24px;
                margin: 40px 0;
              }
              .platform-card {
                background: rgba(30, 41, 59, 0.8);
                border-radius: 16px;
                padding: 32px;
                border: 1px solid rgba(148, 163, 184, 0.1);
                transition: all 0.3s ease;
              }
              .platform-card:hover {
                border-color: #10b981;
                transform: translateY(-4px);
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
              }
              .platform-icon {
                font-size: 56px;
                margin-bottom: 20px;
              }
              .platform-title {
                font-size: 1.5em;
                font-weight: 600;
                color: #f1f5f9;
                margin-bottom: 8px;
              }
              .platform-desc {
                color: #64748b;
                margin-bottom: 24px;
              }
              .download-btn { 
                display: block;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white; 
                padding: 16px 28px; 
                text-decoration: none; 
                border-radius: 12px; 
                font-weight: 600;
                transition: all 0.3s ease;
                text-align: center;
              }
              .download-btn:hover { 
                background: linear-gradient(135deg, #059669, #047857);
                box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
              }
              .install-cmd {
                background: #0f172a;
                color: #10b981;
                padding: 14px 18px;
                border-radius: 10px;
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 0.9em;
                margin-top: 16px;
                overflow-x: auto;
                border: 1px solid rgba(16, 185, 129, 0.2);
              }
              .feature-badge {
                display: inline-block;
                background: rgba(59, 130, 246, 0.2);
                color: #3b82f6;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 0.8em;
                margin-top: 12px;
              }
              .section-title {
                font-size: 1.3em;
                color: #f1f5f9;
                margin-top: 50px;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
              }
              .file-list {
                list-style: none;
              }
              .file-list li {
                padding: 16px 20px;
                background: rgba(30, 41, 59, 0.6);
                border-radius: 10px;
                margin-bottom: 10px;
                border: 1px solid rgba(148, 163, 184, 0.1);
              }
              .file-list a {
                color: #10b981;
                text-decoration: none;
                font-weight: 500;
              }
              .file-list a:hover {
                text-decoration: underline;
              }
              .file-desc {
                color: #64748b;
                font-size: 0.9em;
              }
              footer {
                margin-top: 60px;
                text-align: center;
                color: #64748b;
              }
              footer a {
                color: #10b981;
                text-decoration: none;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üéì SIMAK Exam Browser</h1>
                <p class="subtitle">Secure browser for online examinations</p>
                <div class="version-badge">üì¶ Version VERSION_PLACEHOLDER</div>
              </div>
              
              <div class="platforms">
                <div class="platform-card">
                  <div class="platform-icon">ü™ü</div>
                  <div class="platform-title">Windows 64-bit</div>
                  <p class="platform-desc">Windows 10/11 (64-bit) - Recommended</p>
                  <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER-x64.exe" class="download-btn">
                    ‚¨áÔ∏è Download Installer (64-bit)
                  </a>
                  <div class="feature-badge">‚úÖ Native Keyboard Hook</div>
                </div>
                
                <div class="platform-card">
                  <div class="platform-icon">ü™ü</div>
                  <div class="platform-title">Windows 32-bit</div>
                  <p class="platform-desc">Windows 10/11 (32-bit) atau komputer lama</p>
                  <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER-ia32.exe" class="download-btn">
                    ‚¨áÔ∏è Download Installer (32-bit)
                  </a>
                  <div class="feature-badge">‚úÖ Native Keyboard Hook</div>
                </div>
              </div>
              
              <h3 class="section-title">üìÅ All Files</h3>
              <ul class="file-list">
                <li>
                  <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER-x64.exe">simak-exam-browser-Setup-VERSION_PLACEHOLDER-x64.exe</a>
                  <span class="file-desc"> ‚Äî Windows 64-bit Installer (Recommended)</span>
                </li>
                <li>
                  <a href="simak-exam-browser-Setup-VERSION_PLACEHOLDER-ia32.exe">simak-exam-browser-Setup-VERSION_PLACEHOLDER-ia32.exe</a>
                  <span class="file-desc"> ‚Äî Windows 32-bit Installer</span>
                </li>
                <li>
                  <a href="latest.yml">latest.yml</a>
                  <span class="file-desc"> ‚Äî Auto-update manifest (Windows 64-bit)</span>
                </li>
                <li>
                  <a href="latest-ia32.yml">latest-ia32.yml</a>
                  <span class="file-desc"> ‚Äî Auto-update manifest (Windows 32-bit)</span>
                </li>
              </ul>
              
              <footer>
                <p>üè´ SIMAK KHAS Kempek Cirebon</p>
              </footer>
            </div>
          </body>
          </html>
          HTMLEOF
          
          # Replace version placeholder
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" public/index.html
          
          echo "=== GitHub Pages content ==="
          ls -la public/

      - name: Setup Pages
        uses: actions/configure-pages@v4
        continue-on-error: true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        continue-on-error: true

      - name: Check deployment status
        if: steps.deployment.outcome == 'failure'
        run: |
          echo "::error::GitHub Pages deployment failed!"
          echo ""
          echo "‚ö†Ô∏è  Common causes:"
          echo "1. Repository is PRIVATE - GitHub Pages only works for PUBLIC repositories (free)"
          echo "2. GitHub Pages is not enabled in repository settings"
          echo "3. GitHub Pages is not configured to use GitHub Actions"
          echo ""
          echo "üìã To fix this:"
          echo ""
          echo "If repository is PRIVATE:"
          echo "1. Go to: https://github.com/${{ github.repository }}/settings"
          echo "2. Scroll to 'Danger Zone' ‚Üí 'Change visibility' ‚Üí 'Make public'"
          echo "3. Then continue with steps below"
          echo ""
          echo "If repository is PUBLIC:"
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/pages"
          echo "2. Under 'Source', select 'GitHub Actions' (NOT 'Deploy from a branch')"
          echo "3. Click 'Save'"
          echo "4. Re-run this workflow"
          echo ""
          echo "üìñ For detailed instructions, see: docs/GITHUB_PAGES_SETUP.md"
          echo ""
          echo "‚ÑπÔ∏è  Note: Auto-update will still work via GitHub Releases, but latest.yml files won't be available on GitHub Pages."
          echo "   You can manually download latest.yml from the Release artifacts."

